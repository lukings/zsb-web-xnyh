<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.visolink.system.approval.dao.ApprovalProcessConfigDao">

    <!-- 审批流程配置结果映射 -->
    <resultMap id="ApprovalProcessConfigResultMap" type="cn.visolink.system.approval.bo.ApprovalProcessConfigBO">
        <id column="id" property="id"/>
        <result column="process_name" property="processName"/>
        <result column="process_type" property="processType"/>
        <result column="level_type" property="levelType"/>
        <result column="region_id" property="regionId"/>
        <result column="project_id" property="projectId"/>
        <result column="is_enabled" property="isEnabled"/>
        <result column="is_force" property="isForce"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="is_del" property="isDel"/>
        <result column="region_name" property="regionName"/>
        <result column="project_name" property="projectName"/>
        <result column="process_type_name" property="processTypeName"/>
        <result column="level_type_name" property="levelTypeName"/>
    </resultMap>

    <!-- 审批流程节点结果映射 -->
    <resultMap id="ApprovalProcessNodeResultMap" type="cn.visolink.system.approval.bo.ApprovalProcessNodeBO">
        <id column="id" property="id"/>
        <result column="process_config_id" property="processConfigId"/>
        <result column="node_name" property="nodeName"/>
        <result column="node_type" property="nodeType"/>
        <result column="node_order" property="nodeOrder"/>
        <result column="approval_jobs" property="approvalJobs"/>
        <result column="cc_jobs" property="ccJobs"/>
        <result column="timeout_days" property="timeoutDays"/>
        <result column="is_required" property="isRequired"/>
        <result column="create_by" property="createBy"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="is_del" property="isDel"/>
    </resultMap>

    <!-- 保存审批流程配置 -->
    <insert id="save" parameterType="cn.visolink.system.approval.bo.ApprovalProcessConfigBO">
        INSERT INTO b_approve_process_config (
            id, process_name, process_type, level_type, region_id, project_id,
            is_enabled, is_force, create_by, create_time, update_by, update_time, is_del
        ) VALUES (
            #{id}, #{processName}, #{processType}, #{levelType}, #{regionId}, #{projectId},
            #{isEnabled}, #{isForce}, #{createBy}, #{createTime}, #{updateBy}, #{updateTime}, #{isDel}
        )
    </insert>

    <!-- 更新审批流程配置 -->
    <update id="update" parameterType="cn.visolink.system.approval.bo.ApprovalProcessConfigBO">
        UPDATE b_approve_process_config
        SET process_name = #{processName},
            process_type = #{processType},
            level_type = #{levelType},
            region_id = #{regionId},
            project_id = #{projectId},
            is_enabled = #{isEnabled},
            is_force = #{isForce},
            update_by = #{updateBy},
            update_time = #{updateTime}
        WHERE id = #{id} AND is_del = 0
    </update>

    <!-- 根据ID查询审批流程配置 -->
    <select id="getById" resultMap="ApprovalProcessConfigResultMap">
        SELECT 
            c.*,
            p.AreaName as region_name,
            p.ProjectName as project_name,
            CASE c.process_type
                WHEN '1' THEN '相似客户审批'
                WHEN '2' THEN '客户信息变更审批'
                WHEN '3' THEN '电话/微信跟进审批'
                WHEN '4' THEN '电话/微信且满足三个一的跟进审批'
                WHEN '5' THEN '上门拜访跟进审批'
                WHEN '6' THEN '上门拜访且满足三个一的跟进审批'
                WHEN '7' THEN '邀约到访跟进审批'
                WHEN '8' THEN '邀约到访且满足三个一的跟进审批'
                WHEN '9' THEN '自然来访跟进审批'
                WHEN '10' THEN '自然来访且满足三个一的跟进审批'
                WHEN '11' THEN '其他跟进审批'
                WHEN '12' THEN '其他跟进且满足三个一的审批'
                ELSE ''
            END as process_type_name,
            CASE c.level_type
                WHEN '1' THEN '集团级'
                WHEN '2' THEN '区域级'
                WHEN '3' THEN '项目级'
                ELSE ''
            END as level_type_name
        FROM b_approve_process_config c
        LEFT JOIN b_project p ON c.project_id = p.id AND p.IsDel = 0 AND p.IsStages = 0
        WHERE c.id = #{id} AND c.is_del = 0
    </select>

    <!-- 查询审批流程配置列表 -->
    <select id="select" resultMap="ApprovalProcessConfigResultMap" parameterType="cn.visolink.system.approval.bo.ApprovalProcessQueryBO">
        SELECT 
            c.*,
            p.AreaName as region_name,
            p.ProjectName as project_name,
            CASE c.process_type
                WHEN '1' THEN '相似客户审批'
                WHEN '2' THEN '客户信息变更审批'
                WHEN '3' THEN '电话/微信跟进审批'
                WHEN '4' THEN '电话/微信且满足三个一的跟进审批'
                WHEN '5' THEN '上门拜访跟进审批'
                WHEN '6' THEN '上门拜访且满足三个一的跟进审批'
                WHEN '7' THEN '邀约到访跟进审批'
                WHEN '8' THEN '邀约到访且满足三个一的跟进审批'
                WHEN '9' THEN '自然来访跟进审批'
                WHEN '10' THEN '自然来访且满足三个一的跟进审批'
                WHEN '11' THEN '其他跟进审批'
                WHEN '12' THEN '其他跟进且满足三个一的审批'
                ELSE ''
            END as process_type_name,
            CASE c.level_type
                WHEN '1' THEN '集团级'
                WHEN '2' THEN '区域级'
                WHEN '3' THEN '项目级'
                ELSE ''
            END as level_type_name
        FROM b_approve_process_config c
        LEFT JOIN b_project p ON c.project_id = p.id AND p.IsDel = 0 AND p.IsStages = 0
        WHERE c.is_del = 0
        <if test="processType != null and processType != ''">
            AND c.process_type = #{processType}
        </if>
        <if test="levelType != null and levelType != ''">
            AND c.level_type = #{levelType}
        </if>
        <if test="regionId != null and regionId != ''">
            AND p.AreaID = #{regionId}
        </if>
        <if test="projectId != null and projectId != ''">
            AND c.project_id = #{projectId}
        </if>
        <if test="isEnabled != null">
            AND c.is_enabled = #{isEnabled}
        </if>
        <if test="processName != null and processName != ''">
            AND c.process_name LIKE CONCAT('%', #{processName}, '%')
        </if>
        ORDER BY c.create_time DESC
    </select>

    <!-- 根据流程类型和级别查询审批流程配置 -->
    <select id="getByProcessTypeAndLevel" resultMap="ApprovalProcessConfigResultMap">
        SELECT 
            c.*,
            p.AreaName as region_name,
            p.ProjectName as project_name
        FROM b_approve_process_config c
        LEFT JOIN b_project p ON c.project_id = p.id AND p.IsDel = 0 AND p.IsStages = 0
        WHERE c.is_del = 0
            AND c.process_type = #{processType}
            AND c.level_type = #{levelType}
            <if test="regionId != null and regionId != ''">
                AND p.AreaID = #{regionId}
            </if>
            <if test="projectId != null and projectId != ''">
                AND c.project_id = #{projectId}
            </if>
        ORDER BY c.level_type ASC, c.create_time DESC
        LIMIT 1
    </select>

    <!-- 删除审批流程配置 -->
    <update id="deleteById">
        UPDATE b_approve_process_config SET is_del = 1 WHERE id = #{id}
    </update>

    <!-- 批量删除审批流程配置 -->
    <update id="batchDelete">
        UPDATE b_approve_process_config SET is_del = 1 
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 保存审批流程节点 -->
    <insert id="saveNode" parameterType="cn.visolink.system.approval.bo.ApprovalProcessNodeBO">
        INSERT INTO b_approve_process_node (
            id, process_config_id, node_name, node_type, node_order,
            approval_jobs, cc_jobs, timeout_days, is_required,
            create_by, create_time, update_by, update_time, is_del
        ) VALUES (
            #{id}, #{processConfigId}, #{nodeName}, #{nodeType}, #{nodeOrder},
            #{approvalJobs}, #{ccJobs}, #{timeoutDays}, #{isRequired},
            #{createBy}, #{createTime}, #{updateBy}, #{updateTime}, #{isDel}
        )
    </insert>

    <!-- 更新审批流程节点 -->
    <update id="updateNode" parameterType="cn.visolink.system.approval.bo.ApprovalProcessNodeBO">
        UPDATE b_approve_process_node
        SET node_name = #{nodeName},
            node_type = #{nodeType},
            node_order = #{nodeOrder},
            approval_jobs = #{approvalJobs},
            cc_jobs = #{ccJobs},
            timeout_days = #{timeoutDays},
            is_required = #{isRequired},
            update_by = #{updateBy},
            update_time = #{updateTime}
        WHERE id = #{id} AND is_del = 0
    </update>

    <!-- 根据流程配置ID查询节点列表 -->
    <select id="getNodesByConfigId" resultMap="ApprovalProcessNodeResultMap">
        SELECT * FROM b_approve_process_node
        WHERE process_config_id = #{processConfigId} AND is_del = 0
        ORDER BY node_order ASC
    </select>

    <!-- 删除流程配置下的所有节点 -->
    <update id="deleteNodesByConfigId">
        UPDATE b_approve_process_node SET is_del = 1 WHERE process_config_id = #{processConfigId}
    </update>

    <!-- 根据ID查询节点 -->
    <select id="getNodeById" resultMap="ApprovalProcessNodeResultMap">
        SELECT * FROM b_approve_process_node WHERE id = #{id} AND is_del = 0
    </select>

    <!-- 删除节点 -->
    <update id="deleteNodeById">
        UPDATE b_approve_process_node SET is_del = 1 WHERE id = #{id}
    </update>

    <!-- 检查流程配置是否存在 -->
    <select id="checkExists" resultType="int">
        SELECT COUNT(1) FROM b_approve_process_config c
        LEFT JOIN b_project p ON c.project_id = p.id AND p.IsDel = 0 AND p.IsStages = 0
        WHERE c.is_del = 0
            AND c.process_type = #{processType}
            AND c.level_type = #{levelType}
            <if test="regionId != null and regionId != ''">
                AND p.AreaID = #{regionId}
            </if>
            <if test="projectId != null and projectId != ''">
                AND c.project_id = #{projectId}
            </if>
            <if test="excludeId != null and excludeId != ''">
                AND c.id != #{excludeId}
            </if>
    </select>

</mapper>
