<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.visolink.common.example.mapper.CommonApiMapper">


    <!--查询字典列表-->
    <select id="getCommonDictList" parameterType="java.lang.String" resultType="cn.visolink.common.example.model.Dict">
        SELECT
            ID,
            ListIndex,
            DictCode,
            DictName,
            DictType,
            DictTypeMode,
            ParamMode,
            Unit
        FROM
            s_dictionary
        WHERE
            pid = ( SELECT ID FROM s_dictionary WHERE DictCode = #{dictCode} )
          AND `Status` = 1
          AND isDel =0
         <if test="projectId!=null and projectId !=''">
             AND ProjectID = #{projectId}
         </if>
        <if test="cityId!=null and cityId !=''">
            AND CityId = #{cityId}
        </if>
    </select>

    <!--变更数据状态-->
    <update id="updateDataStatus" parameterType="cn.visolink.common.example.model.DataStatus">
        update ${tableName} set
        Editor = #{userId},
        EditTime = now()
        <if test="status !=null">
            ,status=#{status}
        </if>
        <if test="isDel !=null">
            ,isdel=#{isDel}
        </if>
        where id = #{dataId}
    </update>

    <!--获取登录人所属组织-->
    <select id="getUserOrgList" parameterType="java.lang.String" resultType="cn.visolink.common.example.model.UserOrg">
        SELECT
            A.id,
            A.OrgName,
            A.ListIndex,
            A.FullPath,
            A.PID,
            ( SELECT OrgName FROM S_Organization B WHERE B.ID = A.PID ) AS PName,
            A.ProjectID
        FROM
            S_Organization A
        WHERE
            A.IsDel = 0
          AND A.OrgName IS NOT NULL
          AND A.Id IN (
            SELECT DISTINCT
                SUBSTRING_INDEX( SUBSTRING_INDEX( org_id, ',', b.help_topic_id + 1 ), ',',- 1 )
            FROM
                s_job_org_rel
                    JOIN mysql.help_topic b
            WHERE
                job_id in (	select jobId from s_jobsuserrel where AccountID=#{userId}))
              <if test="type == 2">
                  and A.OrgCategory = 2
              </if>
                <if test="type == 3">
                    and A.OrgCategory = 3
                </if>
                <if test="type == 4">
                    and A.OrgCategory = 4
                </if>
    </select>
</mapper>